<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoopShaper</title>

    <!-- Shoelace -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js"></script>

    <!-- Dockview CSS -->
    <link rel="stylesheet" href="https://unpkg.com/dockview-core@4.13.1/dist/styles/dockview.css">

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Toolbar -->
    <div id="toolbar">
        <div class="toolbar-left">
            <span class="app-title">LoopShaper</span>
        </div>
        <div class="toolbar-right">
            <sl-dropdown id="view-dropdown">
                <sl-button slot="trigger" size="small" caret>View</sl-button>
                <sl-menu id="view-menu">
                    <!-- Menu items will be populated by JavaScript -->
                </sl-menu>
            </sl-dropdown>
        </div>
    </div>

    <!-- Dockview Container (for wide screens) -->
    <div id="dockview-container" class="dockview-theme-light"></div>

    <!-- Narrow Screen Layout (for mobile) -->
    <div id="narrow-layout">
        <div class="narrow-panel">
            <div class="narrow-panel-header">System Definition</div>
            <div class="panel-content">
                <sl-textarea id="narrow-field-code" rows="3" spellcheck="false" resize="auto" class="code-textarea"></sl-textarea>
                <div class="tf-row mt-2">
                    <span id="narrow-eq-L-display" class="eq-display-inline"></span>
                </div>
                <div class="tf-row">
                    <span id="narrow-eq-T-display" class="eq-display-inline"></span>
                </div>
            </div>
        </div>
        <div class="narrow-panel">
            <div class="narrow-panel-header">Parameters</div>
            <div class="panel-content">
                <div class="slider-header">
                    <span>Name</span>
                    <span>Min</span>
                    <span>Max</span>
                    <span>Log</span>
                    <span></span>
                </div>
                <div id="narrow-sliders-container"></div>
                <sl-button size="small" variant="primary" class="mt-2" id="narrow-btn-add-slider">+ Add</sl-button>
            </div>
        </div>
        <div class="narrow-panel">
            <div class="narrow-plot-tabs">
                <button class="narrow-tab-btn active" data-tab="bode">Bode</button>
                <button class="narrow-tab-btn" data-tab="pole-zero">Pole-Zero</button>
                <button class="narrow-tab-btn" data-tab="nyquist">Nyquist</button>
                <button class="narrow-tab-btn" data-tab="step">Step</button>
            </div>
            <div class="panel-content panel-plot" id="narrow-tab-bode">
                <div class="bode-options">
                    <sl-checkbox id="narrow-chk-show-L" checked size="medium" class="bode-label-L">━ $L(s)$</sl-checkbox>
                    <sl-checkbox id="narrow-chk-show-T" checked size="medium" class="bode-label-T">━ $T(s)$</sl-checkbox>
                </div>
                <div id="narrow-bode-wrapper" class="plot-wrapper narrow-plot-wrapper">
                    <canvas id="narrow-bode-canvas"></canvas>
                </div>
            </div>
            <div class="panel-content panel-plot" id="narrow-tab-pole-zero" style="display: none;">
                <div class="pole-options">
                    <sl-checkbox id="narrow-chk-show-L-pz" checked size="medium" class="pole-label-L">L(s)</sl-checkbox>
                    <sl-checkbox id="narrow-chk-show-T-pz" checked size="medium" class="pole-label-T">T(s)</sl-checkbox>
                </div>
                <div id="narrow-pole-wrapper" class="plot-wrapper narrow-plot-wrapper">
                    <canvas id="narrow-pole-canvas"></canvas>
                </div>
            </div>
            <div class="panel-content panel-plot" id="narrow-tab-nyquist" style="display: none;">
                <div id="narrow-nyquist-wrapper" class="plot-wrapper narrow-plot-wrapper">
                    <canvas id="narrow-nyquist-canvas"></canvas>
                    <div class="nyquist-mapping-overlay">
                        <span class="nyquist-mapping-text">Compressed: </span>
                        <span id="narrow-nyquist-mapping-formula"></span>
                    </div>
                    <div id="narrow-nyquist-s-value-overlay" class="nyquist-s-value-overlay"></div>
                    <div class="nyquist-animation-controls">
                        <sl-icon-button id="narrow-nyquist-play-btn" name="play-fill" label="Play/Pause" class="nyquist-play-btn"></sl-icon-button>
                        <sl-range id="narrow-nyquist-seek-bar" min="0" max="1000" value="0" class="nyquist-seek-bar"></sl-range>
                        <button id="narrow-nyquist-speed-btn" class="nyquist-speed-btn">1x</button>
                    </div>
                </div>
            </div>
            <div class="panel-content panel-plot" id="narrow-tab-step" style="display: none;">
                <div class="step-options">
                    <sl-checkbox id="narrow-chk-show-L-step" size="medium" class="step-label-L">━ L(s)</sl-checkbox>
                    <sl-checkbox id="narrow-chk-show-T-step" checked size="medium" class="step-label-T">━ T(s)</sl-checkbox>
                    <div class="step-time-control">
                        <span class="step-time-label">Time:</span>
                        <sl-input id="narrow-step-time-max" type="number" size="small" value="10" min="0.1" step="any" class="step-time-input"></sl-input>
                        <span class="step-time-unit">s</span>
                    </div>
                </div>
                <div id="narrow-step-wrapper" class="plot-wrapper narrow-plot-wrapper">
                    <canvas id="narrow-step-canvas"></canvas>
                </div>
            </div>
        </div>
        <div class="narrow-panel">
            <div class="narrow-panel-header">Stability</div>
            <div class="panel-content">
                <div class="stability-header">
                    <span class="stability-label">Stability</span>
                    <sl-badge id="narrow-stability-indicator" variant="neutral">--</sl-badge>
                </div>
                <div class="stability-info">
                    <div class="info-row">
                        <strong>GM:</strong>
                        <span id="narrow-gm-display" class="text-muted">--</span>
                    </div>
                    <div class="info-row">
                        <strong>PM:</strong>
                        <span id="narrow-pm-display" class="text-muted">--</span>
                    </div>
                </div>
                <div class="nyquist-info">
                    <div class="info-row">
                        <strong>Open-loop RHP poles:</strong>
                        <span id="narrow-open-loop-unstable-display" class="text-muted">--</span>
                    </div>
                    <div class="info-row">
                        <strong>Winding number:</strong>
                        <span id="narrow-winding-number-display" class="text-muted">--</span>
                    </div>
                </div>
                <div class="poles-section">
                    <strong>Closed-loop poles:</strong>
                    <span id="narrow-clp-display" class="text-muted"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Templates -->
    <template id="template-system-definition">
        <div class="panel-content">
            <sl-textarea id="field-code" rows="3" spellcheck="false" resize="auto" class="code-textarea"></sl-textarea>
            <div class="tf-row mt-2">
                <span id="eq-L-display" class="eq-display-inline"></span>
            </div>
            <div class="tf-row">
                <span id="eq-T-display" class="eq-display-inline"></span>
            </div>
        </div>
    </template>

    <template id="template-parameters">
        <div class="panel-content">
            <div class="slider-header">
                <span>Name</span>
                <span>Min</span>
                <span>Max</span>
                <span>Log</span>
                <span></span>
            </div>
            <div id="sliders-container"></div>
            <sl-button size="small" variant="primary" class="mt-2" id="btn-add-slider">+ Add</sl-button>
        </div>
    </template>

    <template id="template-bode">
        <div class="panel-content panel-plot">
            <div class="bode-options">
                <sl-checkbox id="chk-show-L" checked size="small" class="bode-label-L">━ $L(s)$</sl-checkbox>
                <sl-checkbox id="chk-show-T" checked size="small" class="bode-label-T">━ $T(s)$</sl-checkbox>
            </div>
            <div id="bode-wrapper" class="plot-wrapper">
                <canvas id="bode-canvas"></canvas>
            </div>
        </div>
    </template>

    <template id="template-stability">
        <div class="panel-content">
            <div class="stability-header">
                <span class="stability-label">Stability</span>
                <sl-badge id="stability-indicator" variant="neutral">--</sl-badge>
            </div>
            <div class="stability-info">
                <div class="info-row">
                    <strong>GM:</strong>
                    <span id="gm-display" class="text-muted">--</span>
                </div>
                <div class="info-row">
                    <strong>PM:</strong>
                    <span id="pm-display" class="text-muted">--</span>
                </div>
            </div>
            <div class="nyquist-info">
                <div class="info-row">
                    <strong>Open-loop RHP poles:</strong>
                    <span id="open-loop-unstable-display" class="text-muted">--</span>
                </div>
                <div class="info-row">
                    <strong>Winding number:</strong>
                    <span id="winding-number-display" class="text-muted">--</span>
                </div>
            </div>
            <div class="poles-section">
                <strong>Closed-loop poles:</strong>
                <span id="clp-display" class="text-muted"></span>
            </div>
        </div>
    </template>


    <template id="template-pole-zero">
        <div class="panel-content panel-plot">
            <div class="pole-options">
                <sl-checkbox id="chk-show-L-pz" checked size="small" class="pole-label-L">L(s)</sl-checkbox>
                <sl-checkbox id="chk-show-T-pz" checked size="small" class="pole-label-T">T(s)</sl-checkbox>
            </div>
            <div id="pole-wrapper" class="plot-wrapper">
                <canvas id="pole-canvas"></canvas>
            </div>
        </div>
    </template>

    <template id="template-nyquist">
        <div class="panel-content panel-plot">
            <div id="nyquist-wrapper" class="plot-wrapper">
                <canvas id="nyquist-canvas"></canvas>
                <div class="nyquist-mapping-overlay">
                    <span class="nyquist-mapping-text">Compressed: </span>
                    <span id="nyquist-mapping-formula"></span>
                </div>
                <div id="nyquist-s-value-overlay" class="nyquist-s-value-overlay"></div>
                <div class="nyquist-animation-controls">
                    <sl-icon-button id="nyquist-play-btn" name="play-fill" label="Play/Pause" class="nyquist-play-btn"></sl-icon-button>
                    <sl-range id="nyquist-seek-bar" min="0" max="1000" value="0" class="nyquist-seek-bar"></sl-range>
                    <button id="nyquist-speed-btn" class="nyquist-speed-btn">1x</button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-step-response">
        <div class="panel-content panel-plot">
            <div class="step-options">
                <sl-checkbox id="chk-show-L-step" size="small" class="step-label-L">━ L(s)</sl-checkbox>
                <sl-checkbox id="chk-show-T-step" checked size="small" class="step-label-T">━ T(s)</sl-checkbox>
                <div class="step-time-control">
                    <span class="step-time-label">Time:</span>
                    <sl-input id="step-time-max" type="number" size="small" value="10" min="0.1" step="any" class="step-time-input"></sl-input>
                    <span class="step-time-unit">s</span>
                </div>
            </div>
            <div id="step-wrapper" class="plot-wrapper">
                <canvas id="step-canvas"></canvas>
            </div>
        </div>
    </template>

    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Math.js -->
    <script src="https://unpkg.com/mathjs@15.1.0/lib/browser/math.js"></script>

    <!-- Dockview JS -->
    <script src="https://unpkg.com/dockview-core@4.13.1/dist/dockview-core.js"></script>

    <!-- Pako (zlib) for URL compression -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

    <!-- Bode Plot Context Menu -->
    <sl-popup id="bode-context-menu" placement="bottom-start" flip shift>
        <!-- Invisible anchor that we move to the cursor position on right-click -->
        <span id="bode-context-menu-anchor" slot="anchor" class="context-menu-anchor" aria-hidden="true"></span>

        <sl-menu id="bode-context-menu-inner">
            <sl-menu-item type="checkbox" id="bode-opt-margin-lines" value="margin-lines" checked>Show stability margin lines</sl-menu-item>
            <sl-menu-item type="checkbox" id="bode-opt-crossover-lines" value="crossover-lines" checked>Show crossover frequency lines</sl-menu-item>
            <sl-divider></sl-divider>
            <sl-menu-item type="checkbox" id="bode-opt-auto-scale" value="auto-scale" checked>Auto-scale vertical axis</sl-menu-item>
            <div id="bode-custom-range-panel" class="bode-custom-range-panel" style="display: none;">
                <div class="range-input-row">
                    <span class="range-label">Gain [dB]:</span>
                    <sl-input id="bode-gain-min" type="number" size="small" value="-60" class="range-input"></sl-input>
                    <span class="range-separator">–</span>
                    <sl-input id="bode-gain-max" type="number" size="small" value="60" class="range-input"></sl-input>
                </div>
                <div class="range-input-row">
                    <span class="range-label">Phase [°]:</span>
                    <sl-input id="bode-phase-min" type="number" size="small" value="-270" class="range-input"></sl-input>
                    <span class="range-separator">–</span>
                    <sl-input id="bode-phase-max" type="number" size="small" value="90" class="range-input"></sl-input>
                </div>
            </div>
            <sl-divider></sl-divider>
            <sl-menu-item type="checkbox" id="bode-opt-auto-freq" value="auto-freq" checked>Auto frequency range</sl-menu-item>
            <div id="bode-custom-freq-panel" class="bode-custom-range-panel" style="display: none;">
                <div class="range-input-row">
                    <span class="range-label">Freq [rad/s]:</span>
                    <sl-input id="bode-freq-min" type="number" size="small" value="-2" class="range-input" step="0.5"></sl-input>
                    <span class="range-separator">–</span>
                    <sl-input id="bode-freq-max" type="number" size="small" value="3" class="range-input" step="0.5"></sl-input>
                    <span class="range-unit">(10^x)</span>
                </div>
            </div>
        </sl-menu>
    </sl-popup>

    <!-- Custom JS -->
    <script src="utils.js"></script>
    <script src="bode.js"></script>
    <script src="nyquist.js"></script>
    <script src="main.js"></script>
</body>
</html>
